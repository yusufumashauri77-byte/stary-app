<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat na Wadau</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
        body {margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:#0b141a; color:#e9edef; height:100vh; display:flex; overflow:hidden;}
        #sidebar {width:380px; background:#111b21; display:flex; flex-direction:column; border-right:1px solid #30383d;}
        #sidebar-header {background:#202c33; padding:12px; display:flex; align-items:center; justify-content:space-between;}
        #sidebar-header img {width:40px; height:40px; border-radius:50%; cursor:pointer;}
        #chat-list {flex:1; overflow-y:auto;}
        .chat-item {display:flex; align-items:center; padding:12px 15px; cursor:pointer; border-bottom:1px solid #222;}
        .chat-item:hover {background:#2a3942;}
        .chat-item.active {background:#2a3942;}
        .chat-item img {width:50px; height:50px; border-radius:50%; margin-right:15px;}
        .chat-details {flex:1;}
        .chat-name {font-weight:bold; font-size:1.1em;}
        .chat-preview {font-size:0.9em; color:#8696a0;}
        #main {flex:1; display:flex; flex-direction:column; background:url('https://web.whatsapp.com/img/bg-chat-tile-dark_a4be512e7195b6b733d9110b408f075d.png') #0b141a;}
        #chat-header {background:#202c33; padding:15px; display:flex; align-items:center;}
        #chat-header img {width:45px; height:45px; border-radius:50%; margin-right:15px;}
        #room-info {flex:1;}
        #room-name {font-size:1.2em; font-weight:bold;}
        #online-count {font-size:0.9em; color:#00ff00;}
        #messages {flex:1; overflow-y:auto; padding:20px 60px;}
        .message {max-width:65%; margin:10px 0; padding:10px 14px; border-radius:7.5px; word-wrap:break-word; opacity:0; animation:messageIn 0.3s ease-out forwards;}
        .received {background:#202c33; border-top-left-radius:0;}
        .sent {background:#005c4b; align-self:flex-end; border-top-right-radius:0; animation:messageInRight 0.3s ease-out forwards;}
        .message audio, .message video, .message img {max-width:100%; border-radius:8px; margin-top:5px;}
        .time {font-size:0.75em; color:#8696a0; text-align:right; margin-top:5px;}
        .tick {color:#53bdeb;}
        #input-area {background:#202c33; padding:8px 15px; display:flex; align-items:center;}
        #emoji-btn, #attach-btn, #voice-btn {background:none; border:none; font-size:1.8em; cursor:pointer; margin:0 8px;}
        #emoji-picker {display:none; position:absolute; bottom:70px; left:50px; z-index:100; background:#111b21; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.5);}
        #message-input {flex:1; padding:12px 15px; background:#2a3942; border:none; border-radius:30px; color:#e9edef; font-size:1em;}
        #send-btn {background:#00a884; border:none; padding:12px; border-radius:50%; color:white; font-size:1.2em; cursor:pointer;}
        @keyframes messageIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);}}
        @keyframes messageInRight { from {opacity:0; transform:translateY(20px) translateX(20px);} to {opacity:1; transform:translateY(0) translateX(0);}}
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="sidebar-header">
            <img id="my-pic" src="/static/default-avatar.png">
            <div>â‹®</div>
        </div>
        <div id="chat-list">
            <div class="chat-item active" data-room="General">
                <img src="/static/group.png">
                <div class="chat-details">
                    <div class="chat-name">General Group ðŸ‘¥</div>
                    <div class="chat-preview">Karibu wadau!</div>
                </div>
            </div>
        </div>
    </div>

    <div id="main">
        <div id="chat-header">
            <img id="room-pic" src="/static/group.png">
            <div id="room-info">
                <div id="room-name">General Group</div>
                <div id="online-count">1 online</div>
            </div>
        </div>
        <div id="messages"></div>
        <div id="input-area">
            <button id="emoji-btn">ðŸ˜Š</button>
            <emoji-picker id="emoji-picker"></emoji-picker>
            <button id="attach-btn">ðŸ“Ž</button>
            <input type="file" id="file-input" accept="image/*,video/*,audio/*" style="display:none;">
            <input type="text" id="message-input" placeholder="Andika ujumbe...">
            <button id="voice-btn">ðŸŽ¤</button>
            <button id="send-btn">âž¤</button>
        </div>
    </div>

    <script>
        const socket = io();

        let myPhone = prompt("Ingiza namba yako ya simu:", "255712345678") || "255700000000";
        let myName = prompt("Ingiza jina lako:", "Rafiki") || "Rafiki";
        let myPic = "/static/default-avatar.png";
        let currentRoom = "General";

        document.getElementById('my-pic').src = myPic;

        function joinRoom(room) {
            currentRoom = room;
            socket.emit('join', { username: myName, phone: myPhone, profile_pic: myPic, room: room });
        }
        joinRoom(currentRoom);

        const messagesDiv = document.getElementById('messages');
        const input = document.getElementById('message-input');

        function addMessage(data, isOwn) {
            const div = document.createElement('div');
            div.className = `message ${isOwn ? 'sent' : 'received'}`;
            let content = `<strong>${data.username}</strong><br>${data.message || ''}`;
            if (data.file_url) {
                if (data.file_url.includes('.mp4')) content += `<video src="${data.file_url}" controls></video>`;
                else if (data.file_url.includes('webm') || data.file_url.includes('audio')) content += `<audio src="${data.file_url}" controls></audio><br>ðŸ”Š Voice Message`;
                else content += `<img src="${data.file_url}" onclick="window.open(this.src)">`;
            }
            content += `<div class="time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ${isOwn ? '<span class="tick">âœ“âœ“</span>' : ''}</div>`;
            div.innerHTML = content;
            messagesDiv.appendChild(div);
            setTimeout(() => messagesDiv.scrollTop = messagesDiv.scrollHeight, 100);
        }

        socket.on('message_history', (msgs) => {
            messagesDiv.innerHTML = '';
            msgs.forEach(m => addMessage(m, m.phone === myPhone));
        });

        socket.on('new_message', (data) => addMessage(data, data.phone === myPhone));

        socket.on('online_users', (users) => {
            document.getElementById('online-count').textContent = users.length + " online";
        });

        // Emoji picker
        document.getElementById('emoji-btn').onclick = () => {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        };
        document.getElementById('emoji-picker').addEventListener('emoji-click', (e) => {
            input.value += e.detail.unicode;
            input.focus();
        });

        // Attach file
        document.getElementById('attach-btn').onclick = () => document.getElementById('file-input').click();

        // Voice record
        let recorder, audioChunks = [];
        document.getElementById('voice-btn').addEventListener('mousedown', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                recorder.start();
                document.getElementById('voice-btn').textContent = 'âºï¸';
            } catch (err) {
                alert("Ruhusu microphone kwenye browser yako!");
            }
        });
        document.getElementById('voice-btn').addEventListener('mouseup', () => {
            if (recorder) recorder.stop();
            document.getElementById('voice-btn').textContent = 'ðŸŽ¤';
        });
        if (recorder) recorder.onstop = async () => {
            const blob = new Blob(audioChunks, {type: 'audio/webm'});
            const formData = new FormData();
            formData.append('file', blob, 'voice.webm');
            const res = await fetch('/upload', {method: 'POST', body: formData});
            const json = await res.json();
            if (json.url) {
                socket.emit('send_message', {username: myName, phone: myPhone, message: '', file_url: json.url, room: currentRoom});
            }
        };
        if (recorder) recorder.ondataavailable = e => audioChunks.push(e.data);

        // Send message
        async function sendMessage() {
            const msg = input.value.trim();
            let file_url = null;
            if (document.getElementById('file-input').files[0]) {
                const formData = new FormData();
                formData.append('file', document.getElementById('file-input').files[0]);
                const res = await fetch('/upload', {method: 'POST', body: formData});
                const json = await res.json();
                file_url = json.url;
                document.getElementById('file-input').value = '';
            }
            if (msg || file_url) {
                socket.emit('send_message', {
                    username: myName,
                    phone: myPhone,
                    message: msg,
                    file_url: file_url,
                    profile_pic: myPic,
                    room: currentRoom
                });
                input.value = '';
            }
        }

        document.getElementById('send-btn').onclick = sendMessage;
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Switch chat
        document.querySelectorAll('.chat-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentRoom = item.dataset.room;
                document.getElementById('room-name').textContent = item.querySelector('.chat-name').textContent;
                document.getElementById('room-pic').src = item.querySelector('img').src;
                joinRoom(currentRoom);
            });
        });
    </script>
</body>
</html>
